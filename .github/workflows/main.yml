name: CI/CD Pipeline

# –ö–æ–≥–¥–∞ –∑–∞–ø—É—Å–∫–∞—Ç—å: –ø—Ä–∏ –∫–∞–∂–¥–æ–º –ø—É—à–µ –≤ –≤–µ—Ç–∫—É main
on:
  push:
    branches: [ "main" ]

jobs:
  # --- –ß–ê–°–¢–¨ 1: CI (–ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–¥–∞) ---
  tests:
    runs-on: ubuntu-latest
    
    steps:
    - name: –°–∫–∞—á–∏–≤–∞–µ–º –∫–æ–¥
      uses: actions/checkout@v3

    - name: –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º Python
      uses: actions/setup-python@v4
      with:
        python-version: "3.10"

    - name: –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install pytest flake8

    - name: –ó–∞–ø—É—Å–∫–∞–µ–º Linter (–ø—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∏–ª—è)
      # –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞ –≥—Ä—É–±—ã–µ –æ—à–∏–±–∫–∏ —Å–∏–Ω—Ç–∞–∫—Å–∏—Å–∞
      run: |
        flake8 . --count --select=E9,F63,F7,F82 --show-source --statistics

    - name: –ó–∞–ø—É—Å–∫–∞–µ–º –¢–µ—Å—Ç—ã
      # –ó–∞–ø—É—Å–∫–∞–µ–º pytest –¥–ª—è –ø–∞–ø–∫–∏ tests/
      run: |
        pytest tests/

  # --- –ß–ê–°–¢–¨ 2: CD (–î–µ–ø–ª–æ–π –Ω–∞ —Å–µ—Ä–≤–µ—Ä) ---
  deploy:
    needs: tests  # üëà –í–ê–ñ–ù–û: –ó–∞–ø—É—Å—Ç–∏—Ç—Å—è –¢–û–õ–¨–ö–û –µ—Å–ª–∏ —Ç–µ—Å—Ç—ã –ø—Ä–æ—à–ª–∏
    runs-on: ubuntu-latest
    
    steps:
    - name: –ü–æ–¥–∫–ª—é—á–∞–µ–º—Å—è –∫ —Å–µ—Ä–≤–µ—Ä—É –∏ –æ–±–Ω–æ–≤–ª—è–µ–º
      uses: appleboy/ssh-action@master
      with:
        host: ${{ secrets.HOST }}
        username: ${{ secrets.USERNAME }}
        key: ${{ secrets.SSH_KEY }}
        script: |
          cd yoga-scheduler-bot          
          git fetch --all
          git reset --hard origin/main        
          source venv/bin/activate
          pip install -r requirements.txt          
          sudo systemctl restart yoga_scheduler_bot.service